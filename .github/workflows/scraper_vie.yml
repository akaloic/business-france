name: Scraper VIE (daily)

on:
    workflow_dispatch:
    schedule:
        # 05:00 France (CET=UTC+1, CEST=UTC+2). We schedule both and gate by Paris time.
        - cron: "0 4 * * *"
        - cron: "0 3 * * *"

jobs:
    run-scraper:
        runs-on: ubuntu-latest
        env:
            PYTHONUNBUFFERED: "1"
            HEADLESS: "1"
            EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
            EMAIL_TO: ${{ secrets.EMAIL_TO }}
            EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
            SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
            SMTP_PORT: ${{ secrets.SMTP_PORT }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download latest DB artifact (if any)
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  set -euo pipefail
                  ARTIFACT_ID=$(gh api \
                    -H "Accept: application/vnd.github+json" \
                    "/repos/${{ github.repository }}/actions/artifacts?per_page=100" \
                    --jq '.artifacts | map(select(.name=="offres_vie_db")) | sort_by(.created_at) | last | .id')
                  if [ -z "$ARTIFACT_ID" ] || [ "$ARTIFACT_ID" = "null" ]; then
                    echo "No previous DB artifact found."
                    exit 0
                  fi
                  echo "Downloading artifact ID: $ARTIFACT_ID"
                  gh api \
                    -H "Accept: application/vnd.github+json" \
                    "/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip" \
                    > /tmp/offres_vie_db.zip
                  unzip -o /tmp/offres_vie_db.zip -d .
              continue-on-error: true

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  python -m playwright install --with-deps

            - name: Gate by Paris time (05:00)
              run: |
                  HOUR=$(TZ=Europe/Paris date +%H)
                  if [ "$HOUR" != "05" ]; then
                    echo "Not 05:00 in Europe/Paris (now: ${HOUR}). Skipping."
                    exit 0
                  fi

            - name: Run scraper
              run: |
                  python scraper_vie.py

            - name: Upload DB artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: offres_vie_db
                  path: offres_vie.db
                  if-no-files-found: warn
