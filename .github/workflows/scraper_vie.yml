name: Scraper VIE (daily)

on:
    workflow_dispatch:
    schedule:
        # 05:00 France (CET=UTC+1, CEST=UTC+2). We schedule both and gate by Paris time.
        - cron: "0 4 * * *"
        - cron: "0 3 * * *"

jobs:
    run-scraper:
        runs-on: ubuntu-latest
        env:
            PYTHONUNBUFFERED: "1"
            HEADLESS: "1"
            EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
            EMAIL_TO: ${{ secrets.EMAIL_TO }}
            EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
            SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
            SMTP_PORT: ${{ secrets.SMTP_PORT }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  python -m playwright install --with-deps

            - name: Gate by Paris time (05:00)
              run: |
                  HOUR=$(TZ=Europe/Paris date +%H)
                  if [ "$HOUR" != "05" ]; then
                    echo "Not 05:00 in Europe/Paris (now: ${HOUR}). Skipping."
                    exit 0
                  fi

            - name: Run scraper
              run: |
                  python scraper_vie.py
